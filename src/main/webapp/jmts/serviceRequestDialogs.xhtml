<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"> 

    <p:dialog id="serviceRequest"
              width="800"
              height="600"
              draggable="true"
              modal="true"
              rendered="#{serviceManager.user.serviceRequestUnit}"
              widgetVar="serviceRequestDialog"
              maximizable="false"
              closable="true"
              header="Service Request Detail" >

        <p:ajax event="close"    
                process="@this"
                update=":mainTabViewForm:mainTabView:serviceRequestsDatabaseTable,:unitDialogForms:serviceRequest"
                listener="#{serviceManager.closeServiceRequestDialog2(event)}"
                async="true" />

        <p:commandButton actionListener="#{serviceManager.saveCurrentServiceRequest}"
                         onstart="longProcessDialogVar.show();"
                         oncomplete="longProcessDialogVar.hide();"
                         value="Save"
                         update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                         title="Save current job"
                         icon="ui-icon-disk"
                         process=":unitDialogForms:serviceRequest"/>
        <p:commandButton value="Close"
                         actionListener="#{serviceManager.closeServiceRequestDialog1(event)}"
                         async="true"
                         onclick="serviceRequestDialog.hide();"
                         update=":mainTabViewForm:mainTabView:serviceRequestsDatabaseTable,:unitDialogForms:serviceRequest"
                         process=":unitDialogForms:serviceRequest"
                         icon="ui-icon ui-icon-close" />
        <p:spacer height="0" width="100"/>

        <p:commandButton title="Create job" 
                         value="Create Job"
                         actionListener="#{serviceManager.createJobFromServiceRequest}"
                         update=":jobDialogForm:jobFormTabView"
                         onstart="longProcessDialogVar.show();"
                         oncomplete="jobDialog.show();longProcessDialogVar.hide();serviceRequestDialog.hide();mainTabViewVar.select(0);"
                         onerror="connectionErrorDialog.show();"
                         global="true"
                         process="@this"
                         icon="ui-icon-wrench"/>
        <hr/>
        <p:tabView id="serviceRequestDialogTabView" >
            <p:tab title="General">
                <h:panelGrid columns="2" >
                    <h:outputText value="Business office *: " style="font-weight: bold"/>
                    <p:autoComplete style="width: 75%"
                                    var="businessOffice"
                                    value="#{serviceManager.currentServiceRequest.businessOffice}"
                                    itemLabel="#{businessOffice.name}"
                                    itemValue="#{businessOffice}"
                                    converter="businessOfficeConverter"
                                    forceSelection="true"
                                    completeMethod="#{App.completeBusinessOffice}" >
                        <p:ajax event="itemSelect"
                                listener="#{serviceManager.updateBusinessOffice}"
                                process="@this"/>
                    </p:autoComplete>

                    <h:outputText value="Service request number *: " style="font-weight: bold;" />
                    <h:panelGroup>
                        <p:inputText id="serviceRequestNumber"
                                     style="width: 60%"
                                     maxlength="200"
                                     readonly="#{serviceManager.currentServiceRequest.autoGenerateServiceRequestNumber}"
                                     title="#{serviceManager.currentServiceRequest.serviceRequestNumber}"
                                     value="#{serviceManager.currentServiceRequest.serviceRequestNumber}">
                            <p:ajax event="keyup"
                                    global="false"
                                    listener="#{serviceManager.updateServiceRequestNumber}"
                                    process="@this"/>
                        </p:inputText>

                        <h:selectBooleanCheckbox id="autoGenerateServiceRequestNumber"
                                                 value="#{serviceManager.currentServiceRequest.autoGenerateServiceRequestNumber}" >
                            <p:ajax listener="#{serviceManager.updateAutoGenerateServiceRequestNumber}"
                                    global="false"
                                    update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                                    process="@this"/>
                        </h:selectBooleanCheckbox>

                        <p:tooltip for="autoGenerateServiceRequestNumber" value="Check to auto-generate job number" showEffect="fade" hideEffect="fade" />
                        <h:outputLabel for="autoGenerateServiceRequestNumber" value="auto" />
                    </h:panelGroup>

                    <h:outputText value="Client *: " style="font-weight: bold" />
                    <h:panelGroup>
                        <p:autoComplete id="serviceRequestClient"
                                        size="35"
                                        maxlength="250"
                                        maxResults="12"       
                                        value="#{serviceManager.currentServiceRequest.client.name}"
                                        forceSelection="false"
                                        completeMethod="#{App.completeActiveClientName}" >
                            <p:ajax event="itemSelect"                                        
                                    listener="#{serviceManager.updateClient}"
                                    process="@this"/>
                            <p:ajax event="keyup"                                        
                                    listener="#{serviceManager.updateJob}"
                                    process="@this"/>
                        </p:autoComplete>

                        <p:spacer height="0" width="4"/>
                        <p:commandButton icon="ui-icon-pencil"
                                         onstart="longProcessDialogVar.show();"
                                         actionListener="#{serviceManager.editClient}"
                                         update=":clientForm"
                                         oncomplete="clientFormDialog.show();longProcessDialogVar.hide();"
                                         process="@this"
                                         title="View or edit this client's detail"/>
                        <p:spacer height="0" width="4"/>
                    </h:panelGroup>

                    <h:outputText value="Date submitted *:" style="font-weight: bold" />
                    <p:calendar id="dateSubmitted"
                                value="#{serviceManager.currentServiceRequest.dateSubmitted}"
                                navigator="true"
                                pattern="MMM dd, yyyy" >
                        <p:ajax event="dateSelect"
                                update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                                listener="#{serviceManager.handleDateSubmittedSelect}" />
                         <p:ajax event="keyup"
                                update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                                listener="#{serviceManager.handleDateSubmittedSelect}" />
                    </p:calendar>

                    <h:outputText value="Department *: " style="font-weight: bold" />
                    <p:autoComplete id="department"                                       
                                    var="department"
                                    forceSelection="true"
                                    dropdown="false"
                                    size="40"
                                    value="#{serviceManager.currentServiceRequest.department}"
                                    title="#{serviceManager.currentServiceRequest.department}"
                                    itemValue="#{department}"
                                    itemLabel="#{department.name}"
                                    converter="departmentConverter"
                                    completeMethod="#{App.completeDepartment}" >
                        <p:ajax event="itemSelect"
                                listener="#{serviceManager.updateDepartment}"
                                global="false"
                                update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                                process="@this" />
                        <p:ajax event="keyup"
                                listener="#{serviceManager.updateDepartment}"
                                global="false"
                                update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                                process="@this" />
                    </p:autoComplete>

                    <h:outputText value="Dept. Rep./Assignee *: " style="font-weight: bold" />                       
                    <p:autoComplete id="assignee"
                                    var="assignedTo"
                                    size="40"
                                    value="#{serviceManager.currentServiceRequest.assignedTo}"
                                    title="#{serviceManager.currentServiceRequest.assignedTo}"
                                    itemLabel="#{assignedTo.name}"
                                    itemValue="#{assignedTo}"
                                    converter="employeeConverter"
                                    forceSelection="true"
                                    completeMethod="#{App.completeEmployee}" >
                        <p:ajax event="itemSelect"                              
                                listener="#{serviceManager.updateAssignee}"
                                process="@this"/>
                        <p:ajax event="keyup"                             
                                listener="#{serviceManager.updateAssignee}"
                                process="@this"/>
                    </p:autoComplete>   

                    <h:outputText value="Service requested *: " style="font-weight: bold" />                    
                    <p:autoComplete id="serviceRequested"                                       
                                    var="service"
                                    forceSelection="true"
                                    dropdown="true"
                                    maxlength="250"
                                    size="40"
                                    value="#{serviceManager.currentServiceRequest.service}"
                                    title="#{serviceManager.currentServiceRequest.service}"
                                    itemValue="#{service}"
                                    itemLabel="#{service.name}"
                                    converter="serviceConverter"
                                    completeMethod="#{App.completeService}" >
                        <p:ajax event="itemSelect"
                                listener="#{serviceManager.updateJob}"
                                global="false"                                
                                process="@this" />
                        <p:ajax event="keyup"
                                listener="#{serviceManager.updateJob}"
                                global="false"                                
                                process="@this" />
                    </p:autoComplete>
                </h:panelGrid>

                <p:panel header="Description" >
                    <p:inputTextarea
                        value="#{serviceManager.currentServiceRequest.jobDescription}"
                        rows="4"
                        autoResize="false"
                        counter="counter" 
                        maxlength="1000"       
                        counterTemplate="{0} characters remaining." 
                        style="width: 100%;">
                        <p:ajax event="keyup"
                                global="false"                                       
                                listener="#{serviceManager.updateServiceRequest}"
                                process="@this"/>
                    </p:inputTextarea>
                </p:panel>
                <h:outputText id="counter" /> 
            </p:tab>
            <p:tab title="Tracking">
                <h:panelGrid columns="2" >
                    <ui:remove>
                        <h:outputText value="Turnaround time given to customer: " />
                        <h:panelGroup>
                            <p:inputText converter="javax.faces.Integer"
                                         value="#{serviceManager.currentServiceRequest.estimatedTurnAroundTimeInDays}">
                                <p:ajax listener="#{serviceManager.updateServiceRequest}"
                                        global="false"
                                        event="keyup"

                                        process="@this"/>
                            </p:inputText>
                            <h:outputText value=" (working days)" />
                        </h:panelGroup>
                    </ui:remove>

                    <h:outputText value="Entered by: "/>
                    <p:inputText readonly="true"
                                 style="background-color: lightgrey"
                                 value="#{serviceManager.currentServiceRequest.enteredBy.firstName} #{serviceManager.currentServiceRequest.enteredBy.lastName}"
                                 title="#{serviceManager.currentServiceRequest.enteredBy.firstName} #{serviceManager.currentServiceRequest.enteredBy.lastName}"/>

                    <h:outputText value="Last edited by: "/>
                    <p:inputText readonly="true"
                                 style="background-color: lightgrey"
                                 value="#{serviceManager.currentServiceRequest.editedBy.firstName} #{serviceManager.currentServiceRequest.editedBy.lastName}"
                                 title="#{serviceManager.currentServiceRequest.editedBy.firstName} #{serviceManager.currentServiceRequest.editedBy.lastName}"/>

                </h:panelGrid>
                <p:panel header="Status" >
                    <p:inputTextarea
                        value="#{serviceManager.currentServiceRequest.statusNote}"
                        rows="4"
                        autoResize="false"
                        counter="counter2" 
                        maxlength="1000"       
                        counterTemplate="{0} characters remaining." 
                        style="width: 100%;">
                        <p:ajax event="keyup"
                                global="false"                                       
                                listener="#{serviceManager.updateServiceRequest}"
                                process="@this"/>
                    </p:inputTextarea>
                </p:panel>
                <h:outputText id="counter2" /> 
            </p:tab>

        </p:tabView>
        <hr/>
        <p:commandButton actionListener="#{serviceManager.saveCurrentServiceRequest}"
                         onstart="longProcessDialogVar.show();"
                         oncomplete="longProcessDialogVar.hide();"
                         value="Save"
                         update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber"
                         title="Save current job"
                         icon="ui-icon-disk"
                         process=":unitDialogForms:serviceRequest"/>
        <p:commandButton value="Close"
                         actionListener="#{serviceManager.closeServiceRequestDialog1(event)}"
                         async="true"
                         onclick="serviceRequestDialog.hide();"
                         update=":mainTabViewForm:mainTabView:serviceRequestsDatabaseTable,:unitDialogForms:serviceRequest"
                         process=":unitDialogForms:serviceRequest"
                         icon="ui-icon ui-icon-close" />
    </p:dialog>

    <!-- Service request save confirmation dialogs id="serviceRequestSaveConfirmDialogForm", id="serviceRequestDialogForm" -->
    <p:confirmDialog severity="alert"
                     rendered="#{serviceManager.user.serviceRequestUnit}"
                     id="serviceRequestSaveConfirm"
                     message="The current service request (#{serviceManager.currentServiceRequest.serviceRequestNumber}) was modified. Do you wish to save it?"
                     header="Service Request Modified (#{serviceManager.currentServiceRequest.serviceRequestNumber})"
                     widgetVar="serviceRequestSaveConfirmDialog"
                     width="425">

        <p:commandButton value="Yes"                             
                         actionListener="#{serviceManager.saveCurrentServiceRequest}"
                         onstart="longProcessDialogVar.show();"
                         update=":unitDialogForms:serviceRequestDialogTabView:serviceRequestNumber,:mainTabViewForm:mainTabView:serviceRequestsDatabaseTable"
                         oncomplete="longProcessDialogVar.hide();serviceRequestSaveConfirmDialog.hide();"
                         icon="ui-icon-check"
                         process="@this"/>
        <p:commandButton value="No"
                         actionListener="#{serviceManager.cancelServiceRequestEdit}"
                         oncomplete="serviceRequestSaveConfirmDialog.hide();serviceRequestDialog.hide();"
                         process="@this"
                         icon="ui-icon-close"/>       
    </p:confirmDialog>

</html>
