<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://java.sun.com/jsf/facelets"> 
    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="cache-control" content="max-age=0" />
        <meta http-equiv="cache-control" content="no-cache" />
        <meta http-equiv="expires" content="0" />
        <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
        <meta http-equiv="pragma" content="no-cache" />
        <title>Job Costings</title>
        <style type="text/css">
            .ui-widget {
                font-size: 80%;
            }          
            .ui-layout-north {
                z-index:20 !important;
                overflow:visible !important;;
            }

            .ui-layout-north .ui-layout-unit-content {
                overflow:visible !important;
            }
        </style>        
    </h:head>
    <h:body >       
        <ui:insert>                     
            <ui:include src="common/commonDialogs.xhtml" />
            <ui:include src="common/longProcessDialog.xhtml"/>             
        </ui:insert>        
        <p:layout fullPage="true" >
            <p:layoutUnit position="center" >
                <h:form>
                    <p:toolbar>
                        <p:toolbarGroup align="left" >
                            <h:panelGroup >     
                                <p:autoComplete id="jobCostDepartment"                                                
                                                var="department"
                                                forceSelection="true" 
                                                dropdown="false"
                                                size="30"
                                                maxlength="250"
                                                value="#{jobManager.jobCostDepartment}"
                                                title="#{jobManager.jobCostDepartment}"
                                                itemValue="#{department}"
                                                itemLabel="#{department.name}" 
                                                converter="departmentConverter"
                                                completeMethod="#{jobManager.completeDepartment}" >
                                    <p:ajax event="itemSelect"
                                            listener="#{jobManager.updateJobCostDepartment}"   
                                            update=":jobCostsTableForm"
                                            global="false"                                            
                                            process="@this" />
                                    <p:ajax event="keyup"                                            
                                            listener="#{jobManager.updateJobCostDepartment}"
                                            update=":jobCostsTableForm"
                                            global="false"                                           
                                            process="@this" />
                                </p:autoComplete>                                
                                <p:watermark for="jobCostDepartment" value="-- select a department --"/>   
                            </h:panelGroup>
                            <p:spacer height="0" width="25"/>
                            <h:panelGroup>
                                <p:inputText id="jobCostSearchText" 
                                             value="#{jobManager.searchText}" />
                                <p:watermark value="-- enter search text --" for="jobCostSearchText" />
                                <p:spacer height="0" width="5"/>
                                <p:commandButton value="Search"                                                 
                                                 onstart="longProcessDialogVar.show();"
                                                 oncomplete="longProcessDialogVar.hide();"
                                                 onerror="connectionErrorDialog.show();" 
                                                 actionListener="#{jobManager.doJobCostSearch}"
                                                 icon="ui-icon-search"
                                                 process="@this,jobCostDepartment,jobCostSearchText"/>
                            </h:panelGroup>                    

                        </p:toolbarGroup>

                    </p:toolbar>

                </h:form>
                <hr/>

                <h:form id="jobCostsTableForm">
                    <p:dataTable id="jobCostsTable"
                                 var="jobCost"
                                 paginator="true"
                                 rendered="true" 
                                 editable="true" 
                                 editMode="cell"
                                 rows="15"
                                 paginatorTemplate="{FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
                                 value="#{jobManager.jobsWithCostings}">

                        <p:ajax event="cellEdit" listener="#{jobManager.onJobCostingsTableCellEdit}" />  

                        <p:column>
                            <f:facet name="header">
                                <h:outputText value="Job number"/>
                            </f:facet>
                            <h:outputText value="#{jobCost.jobNumber}" />
                        </p:column>

                        <p:column>
                            <f:facet name="header">
                                <h:outputText value="Department"/>
                            </f:facet>
                            <h:outputText value="#{jobCost.department.name}" />
                        </p:column>        

                        <p:column>
                            <f:facet name="header">
                                <h:outputText value="Final Cost"/>
                            </f:facet>
                            <h:outputText value="#{jobCost.jobCostingAndPayment.finalCost}" >
                                <f:convertNumber minFractionDigits="2" maxFractionDigits="2"/>
                            </h:outputText>
                        </p:column>      

                        <p:column headerText="Completed">
                            <p:cellEditor>  
                                <f:facet name="output"><h:selectBooleanCheckbox value="#{jobCost.jobCostingAndPayment.costingCompleted}" /></f:facet>  
                                <f:facet name="input">
                                    <h:selectBooleanCheckbox id="completedId" value="#{jobCost.jobCostingAndPayment.costingCompleted}" >                                         
                                        <p:ajax event="change"
                                                global="false"
                                                update="@this"                                               
                                                process="@this"/>
                                    </h:selectBooleanCheckbox>  
                                </f:facet>  
                            </p:cellEditor>  
                        </p:column>    

                        <p:column>
                            <f:facet name="header">
                                <h:outputText value="Approved"/>
                            </f:facet>
                            <h:selectBooleanCheckbox value="#{jobCost.jobCostingAndPayment.costingApproved}" />
                        </p:column>    

                        <ui:remove>
                            <p:column style="width:32px">
                                <p:commandButton title="View/Edit"
                                                 onstart="longProcessDialogVar.show();"
                                                 onerror="connectionErrorDialog.show();"
                                                 actionListener="#{jobManager.editUnitCost}"
                                                 update=":unitCostForm"
                                                 oncomplete="unitCostDialog.show();"
                                                 global="true"
                                                 icon="ui-icon-pencil">
                                    <f:setPropertyActionListener value="#{unitCost}" 
                                                                 target="#{jobManager.currentUnitCost}" />
                                </p:commandButton>
                            </p:column>
                        </ui:remove>
                    </p:dataTable>
                </h:form>
            </p:layoutUnit>
        </p:layout>

    </h:body>
</html>

